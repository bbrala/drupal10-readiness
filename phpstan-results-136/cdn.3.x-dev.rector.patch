diff --git a/cdn.module b/cdn.module
index a6011d4..f16c77e 100644
--- a/cdn.module
+++ b/cdn.module
@@ -90,7 +90,7 @@ function cdn_editor_js_settings_alter(array &$settings) {
 
   $ckeditor_plugin_manager = \Drupal::service('plugin.manager.ckeditor.plugin');
   $root_relative_file_url = function ($uri) {
-    return file_url_transform_relative(file_create_url($uri));
+    return \Drupal::service('file_url_generator')->generateString($uri);
   };
   foreach ($settings['editor']['formats'] as $format => &$format_settings) {
     if ($format_settings['editor'] === 'ckeditor') {
diff --git a/src/EventSubscriber/HtmlResponseSubscriber.php b/src/EventSubscriber/HtmlResponseSubscriber.php
index f49cbd0..0e4fbc8 100644
--- a/src/EventSubscriber/HtmlResponseSubscriber.php
+++ b/src/EventSubscriber/HtmlResponseSubscriber.php
@@ -26,10 +26,10 @@ class HtmlResponseSubscriber implements EventSubscriberInterface {
   }
 
   /**
-   * @param \Symfony\Component\HttpKernel\Event\FilterResponseEvent $event
+   * @param \Symfony\Component\HttpKernel\Event\ResponseEvent $event
    *   The event to process.
    */
-  public function onRespond(FilterResponseEvent $event) {
+  public function onRespond(\Symfony\Component\HttpKernel\Event\ResponseEvent $event) {
     $response = $event->getResponse();
     if (!$response instanceof HtmlResponse) {
       return;
diff --git a/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php b/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
index df56f77..3c686c4 100644
--- a/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
+++ b/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
@@ -15,6 +15,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnStreamWrapperConstraintValidatorTest extends KernelTestBase {
 
+  use \Prophecy\PhpUnit\ProphecyTrait;
   /**
    * {@inheritdoc}
    */
diff --git a/tests/src/Unit/File/FileUrlGeneratorTest.php b/tests/src/Unit/File/FileUrlGeneratorTest.php
index 1706e51..0e0b8e9 100644
--- a/tests/src/Unit/File/FileUrlGeneratorTest.php
+++ b/tests/src/Unit/File/FileUrlGeneratorTest.php
@@ -23,6 +23,7 @@ use Symfony\Component\HttpFoundation\RequestStack;
  */
 class FileUrlGeneratorTest extends UnitTestCase {
 
+  use \Prophecy\PhpUnit\ProphecyTrait;
   /**
    * The private key to use in tests.
    *
diff --git a/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php b/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
index 5841ac9..f535b94 100644
--- a/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
+++ b/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
@@ -15,6 +15,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnDomainConstraintValidatorTest extends UnitTestCase {
 
+  use \Prophecy\PhpUnit\ProphecyTrait;
   /**
    * @covers ::validate
    *
diff --git a/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php b/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
index 6d21e8b..b0a394d 100644
--- a/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
+++ b/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
@@ -15,6 +15,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnSchemeConstraintValidatorTest extends UnitTestCase {
 
+  use \Prophecy\PhpUnit\ProphecyTrait;
   /**
    * @covers ::validate
    *
diff --git a/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php b/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
index 3f26176..2b7a92b 100644
--- a/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
+++ b/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
@@ -21,6 +21,7 @@ use Symfony\Component\HttpKernel\HttpKernelInterface;
  */
 class DuplicateContentPreventionMiddlewareTest extends UnitTestCase {
 
+  use \Prophecy\PhpUnit\ProphecyTrait;
   /**
    * @covers ::handle
    * @covers ::getRedirectUrl
