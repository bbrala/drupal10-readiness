diff --git a/src/Asset/CssCollectionRenderer.php b/src/Asset/CssCollectionRenderer.php
index fe2e674..df7f622 100644
--- a/src/Asset/CssCollectionRenderer.php
+++ b/src/Asset/CssCollectionRenderer.php
@@ -141,7 +141,7 @@ class CssCollectionRenderer implements AssetCollectionRendererInterface {
           // LINK tag.
           if (!$css_asset['preprocess']) {
             $element = $link_element_defaults;
-            $element['#attributes']['href'] = file_url_transform_relative(file_create_url($css_asset['data'])) . $query_string_separator . $query_string;
+            $element['#attributes']['href'] = \Drupal::service('file_url_generator')->generateString($css_asset['data']) . $query_string_separator . $query_string;
             $element['#attributes']['media'] = $css_asset['media'];
             $element['#browsers'] = $css_asset['browsers'];
             $elements[] = $element;
@@ -161,7 +161,7 @@ class CssCollectionRenderer implements AssetCollectionRendererInterface {
               // control browser-caching. IE7 does not support a media type on
               // the @import statement, so we instead specify the media for
               // the group on the STYLE tag.
-              $import[] = '@import url("' . Html::escape(file_url_transform_relative(file_create_url($next_css_asset['data'])) . '?' . $query_string) . '");';
+              $import[] = '@import url("' . Html::escape(\Drupal::service('file_url_generator')->generateString($next_css_asset['data']) . '?' . $query_string) . '");';
               // Move the outer for loop skip the next item, since we
               // processed it here.
               $i = $j;
diff --git a/tests/src/Unit/EventSubscriber/CspSubscriberTest.php b/tests/src/Unit/EventSubscriber/CspSubscriberTest.php
index 8588bc0..b8d594f 100644
--- a/tests/src/Unit/EventSubscriber/CspSubscriberTest.php
+++ b/tests/src/Unit/EventSubscriber/CspSubscriberTest.php
@@ -36,19 +36,16 @@ class CspSubscriberTest extends UnitTestCase {
   /**
    * {@inheritdoc}
    */
-  public function setUp() {
+  public function setUp(): void {
     parent::setUp();
 
     if (!class_exists(Csp::class)) {
       $this->markTestSkipped('Content Security Policy module is not available.');
     }
 
-    $this->state = $this->getMockBuilder(StateInterface::class)
-      ->getMock();
+    $this->state = $this->createMock(StateInterface::class);
 
-    $this->response = $this->getMockBuilder(HtmlResponse::class)
-      ->disableOriginalConstructor()
-      ->getMock();
+    $this->response = $this->createMock(HtmlResponse::class);
   }
 
   /**
@@ -66,7 +63,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testNoDirectives() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => FALSE,
@@ -96,7 +93,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testStyleNotNeeded() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => TRUE,
@@ -140,7 +137,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testStyleNoPreprocess() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => FALSE,
@@ -184,7 +181,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testStyleMaintenance() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => TRUE,
@@ -228,7 +225,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testStyleElemFallback() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => FALSE,
@@ -263,7 +260,7 @@ class CspSubscriberTest extends UnitTestCase {
    * @covers ::onCspPolicyAlter
    */
   public function testStyleDefaultFallback() {
-    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit_Framework_MockObject_MockObject $configFactory */
+    /** @var \Drupal\Core\Config\ConfigFactoryInterface|\PHPUnit\Framework\MockObject\MockObject $configFactory */
     $configFactory = $this->getConfigFactoryStub([
       'system.performance' => [
         'css.preprocess' => FALSE,
