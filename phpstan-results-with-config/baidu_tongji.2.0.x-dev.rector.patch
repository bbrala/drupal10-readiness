diff --git a/baidu_analytics.info.yml b/baidu_analytics.info.yml
index e8fd5c4..ee945c3 100644
--- a/baidu_analytics.info.yml
+++ b/baidu_analytics.info.yml
@@ -2,7 +2,7 @@ name: 'Baidu Tongji'
 description: 'Allows your site to be tracked by Baidu Analytics by adding a Javascript tracking code to every page.'
 package: Statistics
 type: module
-core_version_requirement: ^8 || ^9
+core_version_requirement: ^9.3 || ^10
 test_dependencies:
   - token:token
 configure: baidu_analytics.admin_settings_form
diff --git a/baidu_analytics.module b/baidu_analytics.module
index c17031b..7641eb6 100644
--- a/baidu_analytics.module
+++ b/baidu_analytics.module
@@ -443,7 +443,7 @@ function _baidu_analytics_cache($location, $sync_cached_file = FALSE) {
           \Drupal::logger('baidu_analytics')->info('Locally cached tracking code file has been saved.');
 
           // Return the local JS file path.
-          return file_url_transform_relative(file_create_url($file_destination));
+          return \Drupal::service('file_url_generator')->generateString($file_destination);
         }
       }
     }
@@ -453,7 +453,7 @@ function _baidu_analytics_cache($location, $sync_cached_file = FALSE) {
   }
   else {
     // Return the local JS file path.
-    return file_url_transform_relative(file_create_url($file_destination));
+    return \Drupal::service('file_url_generator')->generateString($file_destination);
   }
 }
 
diff --git a/baidu_analytics.tokens.inc b/baidu_analytics.tokens.inc
index b9dff84..59940fd 100644
--- a/baidu_analytics.tokens.inc
+++ b/baidu_analytics.tokens.inc
@@ -1,5 +1,6 @@
 <?php
 
+use Drupal\Component\Utility\SafeMarkup;
 /**
  * @file
  * Builds placeholder replacement tokens for user-related data.
@@ -58,12 +59,12 @@ function baidu_analytics_tokens($type, $tokens, array $data = array(), array $op
         // Basic user account information.
         case 'baidu_analytics:role-names':
           $names = implode(',', $account->roles);
-          $replacements[$original] = $sanitize ? \Drupal\Component\Utility\SafeMarkup::checkPlain($names) : $names;
+          $replacements[$original] = $sanitize ? SafeMarkup::checkPlain($names) : $names;
           break;
 
         case 'baidu_analytics:role-ids':
           $ids = implode(',', array_keys($account->roles));
-          $replacements[$original] = $sanitize ? \Drupal\Component\Utility\SafeMarkup::checkPlain($ids) : $ids;
+          $replacements[$original] = $sanitize ? SafeMarkup::checkPlain($ids) : $ids;
           break;
       }
     }
