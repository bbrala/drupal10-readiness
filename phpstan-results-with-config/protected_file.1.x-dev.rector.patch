diff --git a/protected_file.module b/protected_file.module
index 4914d4d..e828fb5 100644
--- a/protected_file.module
+++ b/protected_file.module
@@ -1,5 +1,6 @@
 <?php
 
+use Drupal\file\FileInterface;
 /**
  * @file
  * Contains protected_file.module.
@@ -141,19 +142,19 @@ function template_preprocess_protected_file_widget_multiple(&$variables) {
     if ($element['#display_field']) {
       unset($widget['display']['#title']);
       $display = array(
-        'data' => render($widget['display']),
+        'data' => \Drupal::service('renderer')->render($widget['display']),
         'class' => array('checkbox'),
       );
     }
 
     unset($widget['protected_file']['#title']);
     $protected = array(
-      'data' => render($widget['protected_file']),
+      'data' => \Drupal::service('renderer')->render($widget['protected_file']),
       'class' => array('checkbox'),
     );
 
     $widget['_weight']['#attributes']['class'] = array($weight_class);
-    $weight = render($widget['_weight']);
+    $weight = \Drupal::service('renderer')->render($widget['_weight']);
 
     // Arrange the row with all of the rendered columns.
     $row = array();
@@ -230,7 +231,7 @@ function template_preprocess_protected_file_link(&$variables) {
   // to ensure different file URLs are generated for different sites in a
   // multisite setup, including HTTP and HTTPS versions of the same site.
   // Fix in https://www.drupal.org/node/2646744.
-  $url = file_create_url($file_entity->getFileUri());
+  $url = \Drupal::service('file_url_generator')->generateAbsoluteString($file_entity->getFileUri());
   $variables['#cache']['contexts'][] = 'url.site';
   $variables['#cache']['contexts'][] = 'user.permissions';
 
@@ -281,7 +282,7 @@ function template_preprocess_protected_file_link(&$variables) {
   if (!$current_user->hasPermission('download protected file') && $protected) {
     $variables['attributes']->addClass('file--protected');
     if ($redirect_to_file) {
-      $redirect_uri = file_url_transform_relative(file_create_url($file_entity->getFileUri()));
+      $redirect_uri = \Drupal::service('file_url_generator')->generateString($file_entity->getFileUri());
     }
     else {
       $redirect_uri = \Drupal::request()->getRequestUri();
@@ -314,7 +315,7 @@ function template_preprocess_protected_file_link(&$variables) {
  */
 function protected_file_file_download($uri) {
   // Get the file record based on the URI. If not in the database just return.
-  /** @var \Drupal\file\FileInterface[] $files */
+  /** @var FileInterface[] $files */
   $files = \Drupal::entityTypeManager()
             ->getStorage('file')
             ->loadByProperties(array('uri' => $uri));
@@ -329,7 +330,7 @@ function protected_file_file_download($uri) {
       }
     }
   }
-  /** @var \Drupal\file\FileInterface $file */
+  /** @var FileInterface $file */
   if (!isset($file)) {
     return;
   }
