diff --git a/src/AvatarManager.php b/src/AvatarManager.php
index e475d12..f44e11e 100644
--- a/src/AvatarManager.php
+++ b/src/AvatarManager.php
@@ -201,7 +201,7 @@ class AvatarManager implements AvatarManagerInterface {
         try {
           if (($result = $this->httpClient->get($url)) && ($result->getStatusCode() == 200)) {
             $file_path = $directory . '/' . $user->id() . '.jpg';
-            $file = file_save_data($result->getBody(), $file_path, FileSystemInterface::EXISTS_REPLACE);
+            $file = \Drupal::service('file.repository')->writeData($result->getBody(), $file_path, FileSystemInterface::EXISTS_REPLACE);
           }
         }
         catch (ClientException $e) {
diff --git a/tests/modules/avatars_test/src/Controller/AvatarKitTestController.php b/tests/modules/avatars_test/src/Controller/AvatarKitTestController.php
index b88a202..f4d5410 100644
--- a/tests/modules/avatars_test/src/Controller/AvatarKitTestController.php
+++ b/tests/modules/avatars_test/src/Controller/AvatarKitTestController.php
@@ -15,7 +15,7 @@ class AvatarKitTestController extends ControllerBase {
    */
   public function image() {
     $headers = ['Content-Type' => 'image/png'];
-    $file = drupal_get_path('core', '') . '/misc/druplicon.png';
+    $file = \Drupal::service('extension.path.resolver')->getPath('core', '') . '/misc/druplicon.png';
     return new BinaryFileResponse($file, 200, $headers);
   }
 
diff --git a/tests/src/Functional/AvatarKitAdminSettingsTest.php b/tests/src/Functional/AvatarKitAdminSettingsTest.php
index 2960cd1..ad99070 100644
--- a/tests/src/Functional/AvatarKitAdminSettingsTest.php
+++ b/tests/src/Functional/AvatarKitAdminSettingsTest.php
@@ -12,7 +12,7 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $user = $this->createUser(['administer avatars']);
     $this->drupalLogin($user);
@@ -26,22 +26,22 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
     $avatar_generator2 = $this->createAvatarGenerator(['weight' => 100]);
 
     $this->drupalGet('admin/config/people/avatars');
-    $this->assertResponse(200);
-    $this->assertRaw(t('A list of avatar generators to try for each user in order of preference.'));
+    $this->assertSession()->statusCodeEquals(200);
+    $this->assertSession()->responseContains(t('A list of avatar generators to try for each user in order of preference.'));
 
     // Generator 1 should be in first row, with checked box.
     $elements = $this->xpath('//table//tr[1]/td[1][text()=:label]', [
       ':label' => $avatar_generator1->label(),
     ]);
     $this->assertTrue(!empty($elements), 'Generator on first row.');
-    $this->assertFieldChecked('edit-avatar-generators-' . $avatar_generator1->id() . '-enabled');
+    $this->assertSession()->checkboxChecked('edit-avatar-generators-' . $avatar_generator1->id() . '-enabled');
 
     // Generator 2 should be in fourth row, with unchecked box.
     $elements = $this->xpath('//table//tr[4]/td[1][text()=:label]', [
       ':label' => $avatar_generator2->label(),
     ]);
     $this->assertTrue(!empty($elements), 'Generator on fourth row.');
-    $this->assertNoFieldChecked('edit-avatar-generators-' . $avatar_generator2->id() . '-enabled');
+    $this->assertSession()->checkboxNotChecked('edit-avatar-generators-' . $avatar_generator2->id() . '-enabled');
   }
 
   /**
@@ -49,7 +49,7 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
    */
   public function testGeneratorAdd() {
     $this->drupalGet('admin/config/people/avatars/generators/add');
-    $this->assertResponse(200);
+    $this->assertSession()->statusCodeEquals(200);
 
     $id = mb_strtolower($this->randomMachineName());
     $label = $this->randomString();
@@ -58,11 +58,12 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
       'id' => $id,
       'plugin' => 'avatars_test_dynamic',
     ];
-    $this->drupalPostForm('admin/config/people/avatars/generators/add', $edit, t('Save'));
+    $this->drupalGet('admin/config/people/avatars/generators/add');
+    $this->submitForm($edit, t('Save'));
 
     $t_args = ['%label' => $label];
-    $this->assertRaw(t('Created avatar generator %label', $t_args));
-    $this->assertUrl('admin/config/people/avatars/generators/' . $id);
+    $this->assertSession()->responseContains(t('Created avatar generator %label', $t_args));
+    $this->assertSession()->addressEquals('admin/config/people/avatars/generators/' . $id);
   }
 
   /**
@@ -72,15 +73,16 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
     $avatar_generator = $this->createAvatarGenerator();
 
     $this->drupalGet($avatar_generator->toUrl('edit-form'));
-    $this->assertResponse(200);
+    $this->assertSession()->statusCodeEquals(200);
 
     $t_args = ['%label' => $avatar_generator->label()];
-    $this->assertRaw(t('Edit avatar generator %label', $t_args));
+    $this->assertSession()->responseContains(t('Edit avatar generator %label', $t_args));
 
     $edit = ['label' => $avatar_generator->label()];
-    $this->drupalPostForm($avatar_generator->toUrl('edit-form'), $edit, t('Save'));
-    $this->assertUrl('admin/config/people/avatars');
-    $this->assertRaw(t('Updated avatar generator %label', $t_args));
+    $this->drupalGet($avatar_generator->toUrl('edit-form'));
+    $this->submitForm($edit, t('Save'));
+    $this->assertSession()->addressEquals('admin/config/people/avatars');
+    $this->assertSession()->responseContains(t('Updated avatar generator %label', $t_args));
   }
 
   /**
@@ -89,14 +91,15 @@ class AvatarKitAdminSettingsTest extends AvatarKitWebTestBase {
   public function testGeneratorDelete() {
     $avatar_generator = $this->createAvatarGenerator();
     $this->drupalGet($avatar_generator->toUrl('delete-form'));
-    $this->assertResponse(200);
+    $this->assertSession()->statusCodeEquals(200);
 
     $t_args = ['%label' => $avatar_generator->label()];
-    $this->assertRaw(t('Are you sure you want to delete avatar generator %label?', $t_args));
+    $this->assertSession()->responseContains(t('Are you sure you want to delete avatar generator %label?', $t_args));
+    $this->drupalGet($avatar_generator->toUrl('delete-form'));
 
-    $this->drupalPostForm($avatar_generator->toUrl('delete-form'), [], t('Delete'));
-    $this->assertUrl('admin/config/people/avatars');
-    $this->assertRaw(t('Avatar generator %label was deleted.', $t_args));
+    $this->submitForm([], t('Delete'));
+    $this->assertSession()->addressEquals('admin/config/people/avatars');
+    $this->assertSession()->responseContains(t('Avatar generator %label was deleted.', $t_args));
   }
 
 }
diff --git a/tests/src/Functional/AvatarKitGeneratorTest.php b/tests/src/Functional/AvatarKitGeneratorTest.php
index 99c2a48..db69d2d 100644
--- a/tests/src/Functional/AvatarKitGeneratorTest.php
+++ b/tests/src/Functional/AvatarKitGeneratorTest.php
@@ -88,7 +88,7 @@ class AvatarKitGeneratorTest extends AvatarKitWebTestBase {
     $avatar_preview = $am->findValidAvatar($user);
     $file = $avatar_preview->getAvatar();
 
-    $this->assertEqual($avatar_preview->id(), $am->getAvatarPreviewByFile($file));
+    $this->assertEquals($avatar_preview->id(), $am->getAvatarPreviewByFile($file));
   }
 
   /**
@@ -114,7 +114,7 @@ class AvatarKitGeneratorTest extends AvatarKitWebTestBase {
     $am = \Drupal::service('avatars.avatar_manager');
 
     // Create a random file.
-    $file = file_save_data($this->randomString());
+    $file = \Drupal::service('file.repository')->writeData($this->randomString());
 
     $this->assertFalse($am->getAvatarPreviewByFile($file));
   }
diff --git a/tests/src/Functional/AvatarKitWebTestBase.php b/tests/src/Functional/AvatarKitWebTestBase.php
index aec1616..aed03ba 100644
--- a/tests/src/Functional/AvatarKitWebTestBase.php
+++ b/tests/src/Functional/AvatarKitWebTestBase.php
@@ -38,7 +38,7 @@ abstract class AvatarKitWebTestBase extends BrowserTestBase {
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->avatarGeneratorStorage = $this->container->get('entity_type.manager')->getStorage('avatar_generator');
   }
diff --git a/tests/src/Kernel/AvatarKitManagerTest.php b/tests/src/Kernel/AvatarKitManagerTest.php
index f20aa6b..87a0df7 100644
--- a/tests/src/Kernel/AvatarKitManagerTest.php
+++ b/tests/src/Kernel/AvatarKitManagerTest.php
@@ -41,7 +41,7 @@ class AvatarKitManagerTest extends KernelTestBase {
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->installEntitySchema('user');
     $this->installSchema('system', 'sequences');
diff --git a/tests/src/Kernel/AvatarKitPermissionsTest.php b/tests/src/Kernel/AvatarKitPermissionsTest.php
index c981fef..dd468ae 100644
--- a/tests/src/Kernel/AvatarKitPermissionsTest.php
+++ b/tests/src/Kernel/AvatarKitPermissionsTest.php
@@ -31,7 +31,7 @@ class AvatarKitPermissionsTest extends KernelTestBase {
   /**
    * {@inheritdoc}
    */
-  protected function setUp() {
+  protected function setUp(): void {
     parent::setUp();
     $this->permissionHandler = $this->container->get('user.permissions');
   }
