diff --git a/cdn.module b/cdn.module
index a6011d4..f16c77e 100644
--- a/cdn.module
+++ b/cdn.module
@@ -90,7 +90,7 @@ function cdn_editor_js_settings_alter(array &$settings) {
 
   $ckeditor_plugin_manager = \Drupal::service('plugin.manager.ckeditor.plugin');
   $root_relative_file_url = function ($uri) {
-    return file_url_transform_relative(file_create_url($uri));
+    return \Drupal::service('file_url_generator')->generateString($uri);
   };
   foreach ($settings['editor']['formats'] as $format => &$format_settings) {
     if ($format_settings['editor'] === 'ckeditor') {
diff --git a/src/EventSubscriber/HtmlResponseSubscriber.php b/src/EventSubscriber/HtmlResponseSubscriber.php
index f49cbd0..a8ee169 100644
--- a/src/EventSubscriber/HtmlResponseSubscriber.php
+++ b/src/EventSubscriber/HtmlResponseSubscriber.php
@@ -2,9 +2,9 @@
 
 namespace Drupal\cdn\EventSubscriber;
 
+use Symfony\Component\HttpKernel\Event\ResponseEvent;
 use Drupal\cdn\CdnSettings;
 use Drupal\Core\Render\HtmlResponse;
-use Symfony\Component\HttpKernel\Event\FilterResponseEvent;
 use Symfony\Component\HttpKernel\KernelEvents;
 use Symfony\Component\EventDispatcher\EventSubscriberInterface;
 
@@ -26,10 +26,10 @@ class HtmlResponseSubscriber implements EventSubscriberInterface {
   }
 
   /**
-   * @param \Symfony\Component\HttpKernel\Event\FilterResponseEvent $event
+   * @param \Symfony\Component\HttpKernel\Event\ResponseEvent $event
    *   The event to process.
    */
-  public function onRespond(FilterResponseEvent $event) {
+  public function onRespond(ResponseEvent $event) {
     $response = $event->getResponse();
     if (!$response instanceof HtmlResponse) {
       return;
diff --git a/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php b/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
index df56f77..8a9efd5 100644
--- a/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
+++ b/tests/src/Kernel/CdnStreamWrapperConstraintValidatorTest.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\Tests\cdn\Kernel;
 
+use Prophecy\PhpUnit\ProphecyTrait;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnStreamWrapperConstraint;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnStreamWrapperConstraintValidator;
 use Drupal\KernelTests\KernelTestBase;
@@ -15,6 +16,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnStreamWrapperConstraintValidatorTest extends KernelTestBase {
 
+  use ProphecyTrait;
   /**
    * {@inheritdoc}
    */
diff --git a/tests/src/Unit/File/FileUrlGeneratorTest.php b/tests/src/Unit/File/FileUrlGeneratorTest.php
index 1706e51..49078ab 100644
--- a/tests/src/Unit/File/FileUrlGeneratorTest.php
+++ b/tests/src/Unit/File/FileUrlGeneratorTest.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\Tests\cdn\Unit\File;
 
+use Prophecy\PhpUnit\ProphecyTrait;
 use Drupal\cdn\CdnSettings;
 use Drupal\cdn\File\FileUrlGenerator;
 use Drupal\Component\Utility\Crypt;
@@ -23,6 +24,7 @@ use Symfony\Component\HttpFoundation\RequestStack;
  */
 class FileUrlGeneratorTest extends UnitTestCase {
 
+  use ProphecyTrait;
   /**
    * The private key to use in tests.
    *
diff --git a/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php b/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
index 5841ac9..1a3bcac 100644
--- a/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
+++ b/tests/src/Unit/Plugin/Validation/Constraint/CdnDomainConstraintValidatorTest.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\Tests\cdn\Unit\Plugin\Validation\Constraint;
 
+use Prophecy\PhpUnit\ProphecyTrait;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnDomainConstraint;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnDomainConstraintValidator;
 use Drupal\Tests\UnitTestCase;
@@ -15,6 +16,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnDomainConstraintValidatorTest extends UnitTestCase {
 
+  use ProphecyTrait;
   /**
    * @covers ::validate
    *
diff --git a/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php b/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
index 6d21e8b..91e9aca 100644
--- a/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
+++ b/tests/src/Unit/Plugin/Validation/Constraint/CdnSchemeConstraintValidatorTest.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\Tests\cdn\Unit\Plugin\Validation\Constraint;
 
+use Prophecy\PhpUnit\ProphecyTrait;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnSchemeConstraint;
 use Drupal\cdn\Plugin\Validation\Constraint\CdnSchemeConstraintValidator;
 use Drupal\Tests\UnitTestCase;
@@ -15,6 +16,7 @@ use Symfony\Component\Validator\Violation\ConstraintViolationBuilderInterface;
  */
 class CdnSchemeConstraintValidatorTest extends UnitTestCase {
 
+  use ProphecyTrait;
   /**
    * @covers ::validate
    *
diff --git a/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php b/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
index 3f26176..15862cf 100644
--- a/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
+++ b/tests/src/Unit/StackMiddleware/DuplicateContentPreventionMiddlewareTest.php
@@ -2,6 +2,7 @@
 
 namespace Drupal\Tests\cdn\Unit\StackMiddleware;
 
+use Prophecy\PhpUnit\ProphecyTrait;
 use Drupal\cdn\StackMiddleware\DuplicateContentPreventionMiddleware;
 use Drupal\Core\DependencyInjection\ContainerBuilder;
 use Drupal\Core\Utility\UnroutedUrlAssemblerInterface;
@@ -21,6 +22,7 @@ use Symfony\Component\HttpKernel\HttpKernelInterface;
  */
 class DuplicateContentPreventionMiddlewareTest extends UnitTestCase {
 
+  use ProphecyTrait;
   /**
    * @covers ::handle
    * @covers ::getRedirectUrl
